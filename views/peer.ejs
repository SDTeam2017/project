<!DOCTYPE html>
<html>
  <head>
    <title>peer</title>
    <link rel='stylesheet' href='/stylesheets/style.css'>

  </head>
  <body>
    <h1 class="aliasname" id="alias_id"></h1>
	  <video id="videobox" ></video>
    <div class="aliaslist">
      <table style="width:100%" id="alias_list">
        <tr><th>Alias List</th></tr>
        <tr><th>Peer Name</th>
      </table>
    </div>
  </body>
</html>

<script src="/javascripts/peer.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script >
  var peer_id, name, conn;
  var name;
  var host= <%- JSON.stringify(host) %>

	var peer = new Peer({host: host, port: 9000, path: '/', debug: 3});
  var socket = io.connect();
  peer.on('open', function(){

        socket.on('add',function(client){
              var table = document.getElementById("alias_list");
              var row = table.insertRow(table.rows.length);
              row.setAttribute("id",client['peerid'])
              var cell1 = row.insertCell(0);
              cell1.innerHTML = client['peername'];
         }); 
         socket.on('update',function(client){
              document.getElementById(client['peerid']).cells[0].innerHTML=client['peername'];
         }); 
         socket.on('remove',function(client){
              var rowIndex = document.getElementById(client['peerid']).rowIndex;
              var table = document.getElementById("alias_list");
              table.deleteRow(rowIndex);
         }); 


     function change_name (name){
        var exists=true;
       while(exists==true){
          name = prompt("Please enter an Alias Name for this device:", peer.id);
          if (name== null||/^\s/.test(name)==true||name=="") {
            alert("Alias name cannot be blank or have spaces in front");
          }
          else{
            exists=false;
            socket.emit('check_peer_name',name);
          }
        }
        return name;
     }
      socket.on('name_result',function(result){
        if(result==false)
        {
           socket.emit('editname', name);
           document.getElementById("alias_id").innerHTML ="Alias Name: "+name;
        }
        else
        {
          alert("Alias name exists.");
          name=change_name(name);
        }
      });
     socket.emit('getClientList');
     socket.emit('addnewpeer',peer.id);
     document.getElementById("alias_id").innerHTML ="Alias Name: "+peer.id;
     name=change_name(name);  


     

  });
  
   //fix later to getusermedia.js for all devices to work
  navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia ||    
                         navigator.mediaDevices.webkitGetUserMedia ||
                         navigator.mediaDevices.mozGetUserMedia;



</script>
